<!DOCTYPE html>
<html lang="en">
  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <!-- Metadata, OpenGraph and Schema.org -->




<!-- Standard metadata -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>
  
  
    
      Creating a Mock IDbSet using Moq | Ben Crouse
    
  
</title>
<meta name="author" content="Ben Crouse">
<meta name="description" content="In this post I will demonstrate creating a mock IDbSet for unit testing with Moq
">

  <meta name="keywords" content="software-development, programming, web-development, developer-blog, technology">










<!-- Bootstrap & MDB -->
<link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">



<!-- Fonts & Icons -->
<link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5">
<link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772">
<link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap">

<!-- Code Syntax Highlighting -->
<link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light">



<!-- Styles -->




  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%92%BB&lt;/text&gt;&lt;/svg&gt;">

<link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e">
<link rel="canonical" href="https://bencrouse.com/blog/2016/creating-a-mock-idbset-using-moq/">


  <!-- Dark Mode -->
  <script src="/assets/js/theme.js?61a71b4bf8cc88f490e9b04fb200867e"></script>
  <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark">
  <script>
    initTheme();
  </script>










  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">
    <!-- Header -->
    <header>
  <!-- Nav Bar -->
  <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation">
    <div class="container">
      
        <a class="navbar-brand title font-weight-lighter" href="/">
          
            
              <span class="font-weight-bold">Ben</span>
            
            
            Crouse
          
        </a>
      
      <!-- Navbar Toggle -->
      <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar top-bar"></span>
        <span class="icon-bar middle-bar"></span>
        <span class="icon-bar bottom-bar"></span>
      </button>

      <div class="collapse navbar-collapse text-right" id="navbarNav">
        <ul class="navbar-nav ml-auto flex-nowrap">
          

          <!-- About -->
          <li class="nav-item ">
            <a class="nav-link" href="/">about
              
            </a>
          </li>

          <!-- Other pages -->
          
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
              
                
                <li class="nav-item active">
                  <a class="nav-link" href="/blog/">blog
                    
                  </a>
                </li>
              
            
          
            
              
                
                <li class="nav-item ">
                  <a class="nav-link" href="/cv/">cv
                    
                  </a>
                </li>
              
            
          
          
            <!-- Search -->
            <li class="nav-item">
              <button id="search-toggle" title="Search" onclick="openSearchModal()">
                <span class="nav-link">ctrl k <i class="ti ti-search"></i></span>
              </button>
            </li>
          
          
            <!-- Toogle theme mode -->
            <li class="toggle-container">
              <button id="light-toggle" title="Change theme">
                <i class="ti ti-sun-moon" id="light-toggle-system"></i>
                <i class="ti ti-moon-filled" id="light-toggle-dark"></i>
                <i class="ti ti-sun-filled" id="light-toggle-light"></i>
              </button>
            </li>
          
        </ul>
      </div>
    </div>
  </nav>
  
    <!-- Scrolling Progress Bar -->
    <progress id="progress" value="0">
      <div class="progress-container">
        <span class="progress-bar"></span>
      </div>
    </progress>
  
</header>


    <!-- Content -->
    <div class="container mt-5" role="main">
      
        






<div class="post">
  <header class="post-header">
    <h1 class="post-title">Creating a Mock IDbSet using Moq</h1>
    <p class="post-meta">
      Created on February 10, 2016
      
      
      
    </p>
    <p class="post-tags">
      
        <a href="/blog/2016"> <i class="fa-solid fa-calendar fa-sm"></i> 2016 </a>
      
      

      
    </p>
  </header>

  <article class="post-content">
    
    <div id="markdown-content">
      <p>When using Entity Framework for a project I needed to be able to mock the database context and sets in order to do unit testing. I was able to find some ways to mock the Entity Framework context, but I did not find a complete solution. Most examples did not take into account setting the identity column or deleting items. In order to handle these scenarios I created my own MockDbSet.</p>

<p>I will demonstrate how this works with a sample project for creating and editing reminders.</p>

<p>The context is represented by a simple interface:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IRemindersContext</span>
<span class="p">{</span>
    <span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">Reminder</span><span class="p">&gt;</span> <span class="n">Reminders</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">SaveChangesAsync</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The business logic is in a manager class that takes the context interface as a parameter to enable dependency injection and unit testing:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">ReminderManager</span> <span class="p">:</span> <span class="n">IReminderManager</span>
<span class="p">{</span>
    <span class="n">IRemindersContext</span> <span class="n">_context</span><span class="p">;</span>
    <span class="k">public</span> <span class="nf">ReminderManager</span><span class="p">(</span><span class="n">IRemindersContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_context</span> <span class="p">=</span> <span class="n">context</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Reminder</span><span class="p">&gt;</span> <span class="nf">Get</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_context</span><span class="p">.</span><span class="n">Reminders</span><span class="p">.</span><span class="nf">ToList</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Reminder</span> <span class="nf">Get</span><span class="p">(</span><span class="kt">int</span> <span class="n">reminderId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_context</span><span class="p">.</span><span class="n">Reminders</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">reminderId</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Reminder</span><span class="p">&gt;</span> <span class="nf">Add</span><span class="p">(</span><span class="kt">string</span> <span class="n">description</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">reminder</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Reminder</span> <span class="p">{</span> <span class="n">Description</span> <span class="p">=</span> <span class="n">description</span> <span class="p">};</span>

        <span class="n">_context</span><span class="p">.</span><span class="n">Reminders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">reminder</span><span class="p">);</span>

        <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">reminder</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">Delete</span><span class="p">(</span><span class="kt">int</span> <span class="n">reminderId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">reminder</span> <span class="p">=</span> <span class="n">_context</span><span class="p">.</span><span class="n">Reminders</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">reminderId</span><span class="p">);</span>

        <span class="n">_context</span><span class="p">.</span><span class="n">Reminders</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">reminder</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_context</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">result</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In order to do unit testing of the business logic I need to be able to mock the IDbSet. This is where my mock class comes in. I am using Moq to do create the mocks. The mock IDbSet will be created by a static method on a static class. The method will accept a generic list containing the data that should be returned by the mock IDbSet. The class and method look like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MockDbSet</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">CreateMockDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">data</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
    <span class="err">{</span>
        <span class="err">...</span>
    <span class="err">}</span>
<span class="err">}</span>
</code></pre></div></div>

<p>The first thing I need to do is to set up the mock to behave like an IQueryable<t>. To do this I will create the mock object mock some of the IQueryable methods.</t></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">mock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;();</span>
<span class="kt">var</span> <span class="n">queryData</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">AsQueryable</span><span class="p">();</span>
<span class="n">mock</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="nf">Setup</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Provider</span><span class="p">).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryData</span><span class="p">.</span><span class="n">Provider</span><span class="p">);</span>
<span class="n">mock</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="nf">Setup</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Expression</span><span class="p">).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryData</span><span class="p">.</span><span class="n">Expression</span><span class="p">);</span>
<span class="n">mock</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="nf">Setup</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">ElementType</span><span class="p">).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryData</span><span class="p">.</span><span class="n">ElementType</span><span class="p">);</span>
<span class="n">mock</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="nf">Setup</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">()).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryData</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">());</span>
</code></pre></div></div>

<p>This is all that is needed in order to create a mock that will allow you to select items from it. I want to have add and remove functionality so I need to add those methods to my mock. First, I will find the primary key by using the class name with the suffix “Id”.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
<span class="kt">string</span> <span class="n">colName</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">"Id"</span><span class="p">;</span>
<span class="kt">var</span> <span class="n">pk</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="nf">GetProperty</span><span class="p">(</span><span class="n">colName</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">pk</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">colName</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">"ID"</span><span class="p">;</span>
    <span class="n">pk</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="nf">GetProperty</span><span class="p">(</span><span class="n">colName</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note: Before using the pk you must validate that it is not null.</p>

<p>Now that I have the primary key and I create a method to add new items to the mock IDbSet and return them with the new ID. My implementation supports integer and Guid primary keys.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mock</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;())).</span><span class="nf">Returns</span><span class="p">((</span><span class="n">T</span> <span class="n">x</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pk</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
        <span class="p">||</span> <span class="n">pk</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Int32</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">max</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">d</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pk</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="n">d</span><span class="p">)).</span><span class="nf">Max</span><span class="p">();</span>
        <span class="n">pk</span><span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">max</span> <span class="p">+</span> <span class="m">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pk</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Guid</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">pk</span><span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="n">data</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>The code for remove is much simpler:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mock</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;())).</span><span class="nf">Returns</span><span class="p">((</span><span class="n">T</span> <span class="n">x</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="n">data</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div>

<p>I also need to support Find for my application. This turns out to be the trickiest method to implement. The difficult part is determining the primary key column and using it in a LINQ statement. I already know the primary key column so I will reuse that variable to write the query to find the item. To do this I create an expression tree to build the lambda expression that matches the given value to the primary key.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mock</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[</span><span class="k">]&gt;</span><span class="p">())).</span><span class="nf">Returns</span><span class="p">((</span><span class="kt">object</span><span class="p">[]</span> <span class="n">id</span><span class="p">)</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">param</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Parameter</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">"t"</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">col</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">colName</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Constant</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="m">0</span><span class="p">]));</span>
    <span class="kt">var</span> <span class="n">lambda</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Lambda</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;(</span><span class="n">body</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">queryData</span><span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">lambda</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Here is the complete code for the MockDbSet:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MockDbSet</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">CreateMockDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">data</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
    <span class="err">{</span>
        <span class="nc">var</span> <span class="n">mock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;();</span>
        <span class="kt">var</span> <span class="n">queryData</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">AsQueryable</span><span class="p">();</span>
        <span class="n">mock</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="nf">Setup</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Provider</span><span class="p">).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryData</span><span class="p">.</span><span class="n">Provider</span><span class="p">);</span>
        <span class="n">mock</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="nf">Setup</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">Expression</span><span class="p">).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryData</span><span class="p">.</span><span class="n">Expression</span><span class="p">);</span>
        <span class="n">mock</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="nf">Setup</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="n">ElementType</span><span class="p">).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryData</span><span class="p">.</span><span class="n">ElementType</span><span class="p">);</span>
        <span class="n">mock</span><span class="p">.</span><span class="n">As</span><span class="p">&lt;</span><span class="n">IQueryable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;().</span><span class="nf">Setup</span><span class="p">(</span><span class="n">m</span> <span class="p">=&gt;</span> <span class="n">m</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">()).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">queryData</span><span class="p">.</span><span class="nf">GetEnumerator</span><span class="p">());</span>

        <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
        <span class="kt">string</span> <span class="n">colName</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">"Id"</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">pk</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="nf">GetProperty</span><span class="p">(</span><span class="n">colName</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pk</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">colName</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">"ID"</span><span class="p">;</span>
            <span class="n">pk</span> <span class="p">=</span> <span class="n">type</span><span class="p">.</span><span class="nf">GetProperty</span><span class="p">(</span><span class="n">colName</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pk</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">mock</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;())).</span><span class="nf">Returns</span><span class="p">((</span><span class="n">T</span> <span class="n">x</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pk</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
                    <span class="p">||</span> <span class="n">pk</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Int32</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="kt">var</span> <span class="n">max</span> <span class="p">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">d</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pk</span><span class="p">.</span><span class="nf">GetValue</span><span class="p">(</span><span class="n">d</span><span class="p">)).</span><span class="nf">Max</span><span class="p">();</span>
                    <span class="n">pk</span><span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">max</span> <span class="p">+</span> <span class="m">1</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pk</span><span class="p">.</span><span class="n">PropertyType</span> <span class="p">==</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Guid</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">pk</span><span class="p">.</span><span class="nf">SetValue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="n">data</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
            <span class="p">});</span>
            <span class="n">mock</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;())).</span><span class="nf">Returns</span><span class="p">((</span><span class="n">T</span> <span class="n">x</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">data</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
            <span class="p">});</span>
            <span class="n">mock</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">[</span><span class="k">]&gt;</span><span class="p">())).</span><span class="nf">Returns</span><span class="p">((</span><span class="kt">object</span><span class="p">[]</span> <span class="n">id</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">param</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Parameter</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="s">"t"</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">col</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">colName</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">Expression</span><span class="p">.</span><span class="nf">Constant</span><span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="m">0</span><span class="p">]));</span>
                <span class="kt">var</span> <span class="n">lambda</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Lambda</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;&gt;(</span><span class="n">body</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">queryData</span><span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">lambda</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">mock</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In order to use this in unit tests I will create a mock context class that I can create an instance of for each unit test.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">RemindersContextMock</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IRemindersContext</span><span class="p">&gt;</span> <span class="nf">GetMockContext</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IRemindersContext</span><span class="p">&gt;();</span>

        <span class="n">context</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">Reminders</span><span class="p">).</span><span class="nf">Returns</span><span class="p">(</span><span class="nf">GetReminders</span><span class="p">().</span><span class="n">Object</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">context</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IDbSet</span><span class="p">&lt;</span><span class="n">Reminder</span><span class="p">&gt;&gt;</span> <span class="nf">GetReminders</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">reminders</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Reminder</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="k">new</span> <span class="n">Reminder</span> <span class="p">{</span> <span class="n">ReminderId</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">Description</span> <span class="p">=</span> <span class="s">"Do work"</span> <span class="p">},</span>
            <span class="k">new</span> <span class="n">Reminder</span> <span class="p">{</span> <span class="n">ReminderId</span> <span class="p">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">Description</span> <span class="p">=</span> <span class="s">"Read a book"</span> <span class="p">},</span>
            <span class="k">new</span> <span class="n">Reminder</span> <span class="p">{</span> <span class="n">ReminderId</span> <span class="p">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">Description</span> <span class="p">=</span> <span class="s">"Make dinner"</span> <span class="p">}</span>
        <span class="p">};</span>

        <span class="k">return</span> <span class="n">MockDbSet</span><span class="p">.</span><span class="n">CreateMockDbSet</span><span class="p">&lt;</span><span class="n">Reminder</span><span class="p">&gt;(</span><span class="n">reminders</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I will create a setup method for my unit tests where I create the instance of the manager class to test and pass in my mocked context.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ReminderManager</span> <span class="n">_manager</span><span class="p">;</span>
<span class="n">Mock</span><span class="p">&lt;</span><span class="n">IRemindersContext</span><span class="p">&gt;</span> <span class="n">_context</span><span class="p">;</span>

<span class="p">[</span><span class="n">SetUp</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">SetUp</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">_context</span> <span class="p">=</span> <span class="n">RemindersContextMock</span><span class="p">.</span><span class="nf">GetMockContext</span><span class="p">();</span>

    <span class="n">_manager</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ReminderManager</span><span class="p">(</span><span class="n">_context</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now I can write tests for the methods in the manager class. First I will verify that I can get the list of reminders from the context.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">CanGetReminders</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">reminders</span> <span class="p">=</span> <span class="n">_manager</span><span class="p">.</span><span class="nf">Get</span><span class="p">();</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="n">reminders</span><span class="p">.</span><span class="nf">Count</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Next I will verify that when I add a reminder it gets a valid ID.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">CanAddReminder</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">reminder</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_manager</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">"Walk the dog"</span><span class="p">);</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">AreEqual</span><span class="p">(</span><span class="m">4</span><span class="p">,</span> <span class="n">reminder</span><span class="p">.</span><span class="n">ReminderId</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally I will test the remove method to ensure that it is removing the reminder from the context.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Test</span><span class="p">]</span>
<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">CanDeleteReminder</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">reminder</span> <span class="p">=</span> <span class="n">_manager</span><span class="p">.</span><span class="nf">Get</span><span class="p">().</span><span class="nf">FirstOrDefault</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">Description</span> <span class="p">==</span> <span class="s">"Read a book"</span><span class="p">);</span>
    <span class="k">await</span> <span class="n">_manager</span><span class="p">.</span><span class="nf">Delete</span><span class="p">(</span><span class="n">reminder</span><span class="p">.</span><span class="n">ReminderId</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">reminder2</span> <span class="p">=</span> <span class="n">_manager</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="n">reminder</span><span class="p">.</span><span class="n">ReminderId</span><span class="p">);</span>
    <span class="n">Assert</span><span class="p">.</span><span class="nf">IsNull</span><span class="p">(</span><span class="n">reminder2</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I hope this helps you if you need to create a mock IDbSet. It should be clear now how to add to the mock DbSet’s methods if you need additional functionality.</p>

    </div>
  </article>

  

  

  
    
      

  
    
    
      <br>
      <hr>
      <br>
      <ul class="list-disc pl-8"></ul>

      <!-- Adds related posts to the end of an article -->
      <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2>
    

    <p class="mb-2">Here are some more articles you might like to read next:</p>
  

  <li class="my-2">
    
      <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2016/using-services-in-angularjs-to-share-state/">Using services in AngularJS to share state</a>
    
  </li>

  

  <li class="my-2">
    
      <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2015/timing-health-checks-in-a-functional-way/">Timing Health Checks in a Functional Way</a>
    
  </li>

  

  <li class="my-2">
    
      <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2015/publishing-smartthings-events-to-an-azure-event-hub/">Publishing SmartThings events to an Azure Event Hub</a>
    
  </li>

  

  <li class="my-2">
    
      <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2015/creating-an-azure-sas-token-in-f/">Creating an Azure SAS token in F#</a>
    
  </li>



    
  

  
  
</div>

      
    </div>

    <!-- Footer -->
    


  <footer class="fixed-bottom" role="contentinfo">
    <div class="container mt-0">
      
  © Copyright 2025
  Ben
  
  Crouse. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>.

  
  

    </div>
  </footer>



    <!-- JavaScripts -->
    <!-- jQuery -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<!-- Bootsrap & MDB scripts -->
<script src="/assets/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>


  <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script>























  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script>






<!-- Load Common JS -->
<script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script>
<script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script>
<script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script>

<!-- Jupyter Open External Links New Tab -->
<script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script>

<!-- Badges -->

  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>


  <script async src="https://badge.dimensions.ai/badge.js"></script>



  <!-- MathJax -->
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script>
  
    <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script>
    <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script>
  









  <!-- Scrolling Progress Bar -->
  <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script>







  <!-- Back to Top -->
  <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script>
  <script>
    addBackToTop();
  </script>



  <!-- Search -->
  <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script>
  <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys>
  <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script>
  <script src="/assets/js/search-data.js"></script>
  <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script>




  </body>
</html>
